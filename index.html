<!DOCTYPE html>
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <!-- config handles all sensitive info like api keys/tokens, etc .-->
        <script src="./config.js"></script>
    </head>
    <body>
        <p id="demo"></p>

        <script>

            function scrapeSlackLinks() {
                $.ajax({
                    // this is the javascript channel
                    url: "https://slack.com/api/conversations.history?token=" + slackApi_token + "&channel=" + slackJsChannel + "&pretty=1"

                    //this is the test channel
                    //url: "https://slack.com/api/conversations.history?token=" + slackApi_token + "&channel=" + slackTestChannel + "&pretty=1"
                }).done(function(response) {
                    var filter = [];
                    for (var i = 0; i < response.messages.length; i++){
                        if(response.messages[i].attachments){
                            console.log(response.messages[i].attachments);
                            if(!response.messages[i].hasOwnProperty('subtype') && response.messages[i].attachments[0].hasOwnProperty('title')){
                                var origLink = '<li style=\'border:1px solid; margin: 10px 0 10px 0; padding: 10px;\'><p>' + response.messages[i].attachments[0].text + '<\/p><a href=\'' + response.messages[i].attachments[0].original_url + '\' target=\'_blank\'>' + response.messages[i].attachments[0].title + '<\/a><\/li>'
                                var cleanLink = origLink.replace(/\//g, "\\/");
                                filter.push(cleanLink);
                            }
                        }   
                    }

                    document.getElementById("demo").innerHTML = '<h1>Links from the last week in the JavaScript Slack channel</h1><ul>' + filter + '</ul>';

                    sendToMailChimp(filter);
                });
            }

            function sendToMailChimp(filter) {
                var filterToString = filter.toString();
                var cleanFilter = filterToString.replace(/,/g, "");
                var links = "{\n\t\"html\": \"<h1>Links from the last week in the JavaScript Slack channel<\/h1><ul style=\'list-style: none;\'>" + cleanFilter + "</ul>\"\n}"


                // Only classic templates in MailChimp work with the API
                var settings = {
                    "url": "https://" + mailChimpApiKey + ".api.mailchimp.com/3.0/templates/" + mailChimpTemplateKey,
                    "method": "PATCH",
                    "headers": {
                        "Content-Type": "application/json",
                        "Authorization": mailChimpAuth,
                        "Cache-Control": "no-cache",
                        "Postman-Token": postmanToken
                    },
                    "data": links
                }   

                //console.log(links);

                $.ajax(settings).done(function(response) {
                    console.log(response);
                }).fail(function(response) {
                    console.log(response);   
                });
            }

            scrapeSlackLinks();
        </script>

    </body>
</html>